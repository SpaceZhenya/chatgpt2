<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ò–ò-—á–∞—Ç —Å –≥–æ–ª–æ—Å–æ–º</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f9; }
    #chat { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; background: white; }
    .msg { margin: 5px 0; white-space: pre-wrap; }
    .user { color: blue; }
    .bot { color: green; }
    #controls { margin-top: 10px; }
  </style>
</head>
<body>
<h2>–ò–ò-—á–∞—Ç (Gemini 2.5 Flash + –≥–æ–ª–æ—Å)</h2>
<div id="chat"></div>

<div id="controls">
  <input id="input" type="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="width:60%">
  <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  <button onclick="startListening()">üé§ –ì–æ–≤–æ—Ä–∏—Ç—å</button>
  <button onclick="resetChat()">–°–±—Ä–æ—Å–∏—Ç—å</button>
  <button onclick="saveChat()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const API_KEY = "AIzaSyCPJwayDaH4Lrb0fw8MypQYHP3xdr2KA9I"; // –≤—Å—Ç–∞–≤—å —Å–≤–æ–π –∫–ª—é—á Gemini
const MODEL = "gemini-2.5-flash";
let history = [];

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
function addMessage(sender, text) {
  const div = document.createElement('div');
  div.className = 'msg ' + sender;
  div.textContent = sender.toUpperCase() + ': ' + text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

// –°–±—Ä–æ—Å —á–∞—Ç–∞
function resetChat() {
  history = [];
  chat.innerHTML = "";
  addMessage("bot", "–ß–∞—Ç –æ—á–∏—â–µ–Ω. –ù–∞—á–Ω—ë–º –∑–∞–Ω–æ–≤–æ!");
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
function saveChat() {
  let text = "";
  history.forEach(m => {
    const role = m.role === "user" ? "–¢—ã" : "–ë–æ—Ç";
    text += `${role}: ${m.parts[0].text}\n`;
  });
  const blob = new Blob([text], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "chat_history.txt";
  a.click();
  URL.revokeObjectURL(url);
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≤ —á–∞—Ç
async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;

  addMessage('user', text);
  history.push({ role: "user", parts: [{ text }] });
  input.value = '';

  const botDiv = addMessage('bot', "–î—É–º–∞—é...");

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: history })
      }
    );

    const data = await response.json();
    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "–ù–µ –ø–æ–Ω—è–ª ü§î";

    botDiv.textContent = "";
    addMessage("bot", reply);
    history.push({ role: "model", parts: [{ text: reply }] });

    // –æ–∑–≤—É—á–∫–∞ –æ—Ç–≤–µ—Ç–∞
    const utterance = new SpeechSynthesisUtterance(reply);
    utterance.lang = "ru-RU";
    speechSynthesis.speak(utterance);

  } catch (err) {
    botDiv.textContent = "BOT: –û—à–∏–±–∫–∞ (" + err.message + ")";
  }
}

// –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
function startListening() {
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'ru-RU';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.start();
  recognition.onresult = (event) => {
    const speech = event.results[0][0].transcript;
    input.value = speech;
    sendMessage();
  };
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
input.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });

// –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
addMessage("bot", "–ü—Ä–∏–≤–µ—Ç! –Ø Gemini 2.5 Flash. –ú–æ–∂–µ—à—å –ø–∏—Å–∞—Ç—å –∏–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.");
</script>
</body>
</html>
