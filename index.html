<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Pingvi v5 ğŸ§</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f9; }
  h2 { display:flex; align-items:center; }
  #chat { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; background: white; }
  .msg { margin: 10px 0; display:flex; align-items:flex-start; }
  .user { color: blue; }
  .bot { color: green; }
  .penguin { font-size: 50px; margin-right:10px; }
  .text { max-width: 80%; }
  #controls { margin-top: 10px; }
  .markdown p { margin: 5px 0; }
  .markdown code { background:#eee; padding:2px 4px; border-radius:4px; }
  .markdown pre { background:#eee; padding:8px; border-radius:8px; overflow-x:auto; }
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<h2>Pingvi v5 ğŸ§</h2>
<div id="chat"></div>

<div id="controls">
  <input id="input" type="text" placeholder="ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..." style="width:50%">
  <button onclick="sendMessage()">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
  <button onclick="startListening()">ğŸ¤ Ğ“Ğ¾Ğ»Ğ¾Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ</button>
  <button onclick="resetChat()">Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ</button>
  <button onclick="saveChat()">ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
  <br><br>
  <label>Ğ ĞµĞ¶Ğ¸Ğ¼ Pingvi:</label>
  <select id="modeSelect">
    <option value="normal">ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹</option>
    <option value="joke">Ğ¨ÑƒÑ‚Ğ»Ğ¸Ğ²Ñ‹Ğ¹ ğŸ²</option>
    <option value="teacher">Ğ£Ñ‡Ğ¸Ñ‚ĞµĞ»ÑŒ ğŸ‘¨â€ğŸ«</option>
    <option value="philosopher">Ğ¤Ğ¸Ğ»Ğ¾ÑĞ¾Ñ„ ğŸ¤”</option>
    <option value="motivator">ĞœĞ¾Ñ‚Ğ¸Ğ²Ğ°Ñ‚Ğ¾Ñ€ ğŸ’ª</option>
    <option value="historian">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ğº ğŸ“œ</option>
    <option value="poet">ĞŸĞ¾ÑÑ‚ âœ’ï¸</option>
    <option value="gamer">Ğ“ĞµĞ¹Ğ¼ĞµÑ€ ğŸ®</option>
    <option value="scientist">Ğ£Ñ‡Ñ‘Ğ½Ñ‹Ğ¹ ğŸ”¬</option>
    <option value="chef">Ğ¨ĞµÑ„-Ğ¿Ğ¾Ğ²Ğ°Ñ€ ğŸ‘¨â€ğŸ³</option>
  </select>
  <br><br>
  <label>Ğ“Ñ€Ğ¾Ğ¼ĞºĞ¾ÑÑ‚ÑŒ: <span id="volLabel">50</span>%</label>
  <input type="range" id="volumeSlider" min="0" max="100" value="50">
  <br><br>
  <label>Ğ“Ğ¾Ğ»Ğ¾Ñ Pingvi:</label>
  <select id="voiceSelect"></select>
  <br><br>
  <label>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºÑƒ:</label>
  <input type="file" id="imageUpload" accept="image/*">
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const volumeSlider = document.getElementById('volumeSlider');
const volLabel = document.getElementById('volLabel');
const voiceSelect = document.getElementById('voiceSelect');
const imageUpload = document.getElementById('imageUpload');
const modeSelect = document.getElementById('modeSelect');

const API_KEY = "AIzaSyCPJwayDaH4Lrb0fw8MypQYHP3xdr2KA9I";
const MODEL = "gemini-2.5-flash";
let history = [];
let recognition = null;
let volume = 0.5;
let voices = [];

// ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ³Ñ€Ğ¾Ğ¼ĞºĞ¾ÑÑ‚Ğ¸
volumeSlider.addEventListener('input', () => {
  volume = volumeSlider.value / 100;
  volLabel.textContent = volumeSlider.value;
});

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²
function loadVoices() {
  voices = speechSynthesis.getVoices();
  voiceSelect.innerHTML = "";
  voices.forEach((v, i) => {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = `${v.name} (${v.lang})`;
    voiceSelect.appendChild(option);
  });
}
speechSynthesis.onvoiceschanged = loadVoices;

// Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
function addMessage(sender, text, markdown=false) {
  const div = document.createElement('div');
  div.className = 'msg ' + sender;

  if(sender === 'bot') {
    const penguin = document.createElement('span');
    penguin.className = 'penguin';
    penguin.textContent = 'ğŸ§';
    div.appendChild(penguin);
  }

  const span = document.createElement('div');
  span.className = 'text markdown';
  span.innerHTML = markdown ? marked.parse(text) : text;
  div.appendChild(span);

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

// Ğ¡Ğ±Ñ€Ğ¾Ñ
function resetChat() {
  history = [];
  chat.innerHTML = "";
  addMessage("bot", "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ Pingvi ğŸ§. Ğ”Ğ°Ğ²Ğ°Ğ¹ Ğ¿Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ğ¼!", true);
}

// Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸
function saveChat() {
  let text = "";
  history.forEach(m => {
    const role = m.role === "user" ? "Ğ¢Ñ‹" : "Pingvi";
    text += `${role}: ${m.parts[0].text}\n`;
  });
  const blob = new Blob([text], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "chat_history.txt";
  a.click();
  URL.revokeObjectURL(url);
}

// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ğ¿Ğ¾ Ñ€ĞµĞ¶Ğ¸Ğ¼Ñƒ
function getSystemInstruction() {
  switch(modeSelect.value) {
    case "joke": return "ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ğ²ĞµÑĞµĞ»Ğ¾, ÑˆÑƒÑ‚Ğ¸, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ÑĞ¼Ğ°Ğ¹Ğ»Ñ‹, Ğ±ÑƒĞ´ÑŒ Ğ·Ğ°Ğ±Ğ°Ğ²Ğ½Ñ‹Ğ¼ Ğ¿Ğ¸Ğ½Ğ³Ğ²Ğ¸Ğ½Ğ¾Ğ¼.";
    case "teacher": return "ĞĞ±ÑŠÑÑĞ½ÑĞ¹ ĞºĞ°Ğº ÑƒÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒ: Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ğ¾, Ğ¿Ğ¾ÑˆĞ°Ğ³Ğ¾Ğ²Ğ¾, Ğ·Ğ°Ğ´Ğ°Ğ²Ğ°Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ ÑƒÑ‡ĞµĞ½Ğ¸ĞºÑƒ.";
    case "philosopher": return "ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ğ¼ÑƒĞ´Ñ€Ğ¾, Ğ³Ğ»ÑƒĞ±Ğ¾ĞºĞ¾, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ñ„Ğ¸Ğ»Ğ¾ÑĞ¾Ñ„ÑĞºĞ¸Ğµ Ñ€Ğ°ÑÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ñ.";
    case "motivator": return "Ğ‘ÑƒĞ´ÑŒ Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼: Ğ²Ğ´Ğ¾Ñ…Ğ½Ğ¾Ğ²Ğ»ÑĞ¹, Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ğ¹, Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸ Ñ ÑĞ½ĞµÑ€Ğ³Ğ¸ĞµĞ¹.";
    case "historian": return "ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ ĞºĞ°Ğº Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğº: Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾, Ñ Ñ„Ğ°ĞºÑ‚Ğ°Ğ¼Ğ¸ Ğ¸ Ğ´Ğ°Ñ‚Ğ°Ğ¼Ğ¸, Ğ¾Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°Ğ¹ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾.";
    case "poet": return "ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ ÑÑ‚Ğ¸Ñ…Ğ°Ğ¼Ğ¸ Ğ¸Ğ»Ğ¸ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ñ„Ñ€Ğ°Ğ·Ğ°Ğ¼Ğ¸, ĞºĞ°Ğº Ğ¿Ğ¾ÑÑ‚.";
    case "gamer": return "ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ ĞºĞ°Ğº Ğ³ĞµĞ¹Ğ¼ĞµÑ€: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ÑĞ»ĞµĞ½Ğ³ Ğ¸ Ğ¸Ğ³Ñ€Ğ¾Ğ²Ñ‹Ğµ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ñ‹.";
    case "scientist": return "ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ ĞºĞ°Ğº ÑƒÑ‡Ñ‘Ğ½Ñ‹Ğ¹: Ñ‚Ğ¾Ñ‡Ğ½Ğ¾, Ñ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ¼Ğ¸ Ğ¸ Ñ„Ğ°ĞºÑ‚Ğ°Ğ¼Ğ¸, ĞºĞ°Ğº Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ.";
    case "chef": return "ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ ĞºĞ°Ğº ÑˆĞµÑ„-Ğ¿Ğ¾Ğ²Ğ°Ñ€: Ğ´Ğ°Ğ²Ğ°Ğ¹ ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ¸ Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñ‹, Ğ¾Ğ±ÑŠÑÑĞ½ÑĞ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ¸.";
    default: return "ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ ÑĞ¿Ğ¾ĞºĞ¾Ğ¹Ğ½Ğ¾ Ğ¸ Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ğ¾, ĞºĞ°Ğº Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº.";
  }
}

// ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
async function sendMessage(imageData=null) {
  const text = input.value.trim();
  if(!text && !imageData) return;

  if(text) {
    addMessage('user', text);
    history.push({ role:"user", parts:[{text}] });
  }
  input.value='';

  const botDiv = addMessage('bot', "Pingvi Ğ´ÑƒĞ¼Ğ°ĞµÑ‚...");

  try {
    let body = { contents: history };
    if(imageData) {
      history.push({ role:"user", parts:[{ text: "Ğ§Ñ‚Ğ¾ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¾ Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞµ?" }, { inlineData: { mimeType: "image/png", data: imageData } }] });
      body = { contents: history };
    }

    body.systemInstruction = { parts: [{ text: getSystemInstruction() }] };

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      }
    );

    const data = await response.json();
    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "ĞĞµ Ğ¿Ğ¾Ğ½ÑĞ» ğŸ¤”";

    botDiv.remove();
    addMessage("bot", reply, true);
    history.push({ role:"model", parts:[{text:reply}] });

    // ĞĞ·Ğ²ÑƒÑ‡ĞºĞ°
    const utterance = new SpeechSynthesisUtterance(reply);
    utterance.lang="ru-RU";
    utterance.volume = volume;
    if(voices.length > 0) {
      utterance.voice = voices[voiceSelect.value] || voices[0];
    }
    speechSynthesis.speak(utterance);

  } catch(err) {
    botDiv.textContent = "Pingvi: ĞÑˆĞ¸Ğ±ĞºĞ° ("+err.message+")";
  }
}

// Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğ¹ Ğ²Ğ²Ğ¾Ğ´
function startListening() {
  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang='ru-RU';
  recognition.interimResults=false;
  recognition.maxAlternatives=1;

  recognition.start();
  recognition.onresult = (event) => {
    const speech = event.results[0][0].transcript;
    input.value = speech;
    sendMessage();
    recognition.start();
  };

  recognition.onerror = (event) => {
    console.error("Speech recognition error", event);
    recognition.stop();
  };
}

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ¸
imageUpload.addEventListener("change", () => {
  const file = imageUpload.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const base64 = reader.result.split(",")[1];
    sendMessage(base64);
  };
  reader.readAsDataURL(file);
});

// Enter Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸
input.addEventListener("keydown", e=>{ if(e.key==="Enter") sendMessage(); });

// Ğ¡Ñ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ
resetChat();
loadVoices();
</script>
</body>
</html>
