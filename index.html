<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ò–ò-—á–∞—Ç —Å –≤–∏–¥–µ–æ –∏ –≥–æ–ª–æ—Å–æ–º</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f9; }
  #chat { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; background: white; }
  .msg { margin: 5px 0; white-space: pre-wrap; }
  .user { color: blue; }
  .bot { color: green; }
  #videoContainer { margin-top: 10px; }
</style>
</head>
<body>
<h2>–ò–ò-—á–∞—Ç —Å –≤–∏–¥–µ–æ –∏ –≥–æ–ª–æ—Å–æ–º</h2>
<div id="chat"></div>

<div id="controls">
  <input id="input" type="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="width:50%">
  <button onclick="sendMessage(false)">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  <button onclick="sendMessage(true)">üéô –ì–æ–ª–æ—Å –ò–ò</button>
  <button onclick="startCamera()">üìπ –í–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ + –≥–æ–ª–æ—Å</button>
  <button onclick="resetChat()">–°–±—Ä–æ—Å–∏—Ç—å</button>
  <button onclick="saveChat()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<div id="videoContainer">
  <video id="video" width="320" height="240" autoplay muted></video>
  <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const API_KEY = "AIzaSyCPJwayDaH4Lrb0fw8MypQYHP3xdr2KA9I";
const MODEL = "gemini-2.5-flash";
let history = [];
let stream = null;
let recognition = null;

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
function addMessage(sender, text) {
  const div = document.createElement('div');
  div.className = 'msg ' + sender;
  div.textContent = sender.toUpperCase() + ': ' + text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

// –°–±—Ä–æ—Å —á–∞—Ç–∞
function resetChat() {
  history = [];
  chat.innerHTML = "";
  addMessage("bot", "–ß–∞—Ç –æ—á–∏—â–µ–Ω. –ù–∞—á–Ω—ë–º –∑–∞–Ω–æ–≤–æ!");
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
function saveChat() {
  let text = "";
  history.forEach(m => {
    const role = m.role === "user" ? "–¢—ã" : "–ë–æ—Ç";
    text += `${role}: ${m.parts[0].text}\n`;
  });
  const blob = new Blob([text], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "chat_history.txt";
  a.click();
  URL.revokeObjectURL(url);
}

// –°–Ω–∏–º–æ–∫ —Å –≤–∏–¥–µ–æ
function captureFrame() {
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  return canvas.toDataURL('image/png'); // base64
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage(speak=false) {
  let text = input.value.trim();
  if(!text && !stream) return;

  let snapshot = stream ? captureFrame() : null;
  if(text) {
    addMessage('user', text);
    history.push({ role:"user", parts:[{text}] });
    input.value='';
  }

  const botDiv = addMessage('bot', "–î—É–º–∞—é...");

  try {
    let contents = [...history];
    if(snapshot) {
      contents.push({
        role: "user",
        parts: [{ image: snapshot }],
        type: "image"
      });
    }

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents })
      }
    );

    const data = await response.json();
    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "–ù–µ –ø–æ–Ω—è–ª ü§î";

    botDiv.textContent = "";
    addMessage("bot", reply);
    history.push({ role:"model", parts:[{text:reply}] });

    if(speak) {
      const utterance = new SpeechSynthesisUtterance(reply);
      utterance.lang="ru-RU";
      speechSynthesis.speak(utterance);
    }

  } catch(err) {
    botDiv.textContent = "BOT: –û—à–∏–±–∫–∞ ("+err.message+")";
  }
}

// –í–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã + –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ + –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    video.srcObject = stream;
    addMessage("bot", "–í–∏–¥–µ–æ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω—ã. –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –≥–æ–≤–æ—Ä–∏—Ç—å —Å –ò–ò –æ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–µ–º.");

    // –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang='ru-RU';
    recognition.interimResults=false;
    recognition.maxAlternatives=1;

    recognition.start();
    recognition.onresult = (event) => {
      const speech = event.results[0][0].transcript;
      input.value = speech;
      sendMessage(false); // –≥–æ–ª–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –±–æ—Ç –±–µ–∑ –æ–∑–≤—É—á–∫–∏
      recognition.start(); // –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–ª—É—à–∞—Ç—å
    };

    recognition.onerror = (event) => {
      console.error("Speech recognition error", event);
      recognition.stop();
    };

  } catch(err) {
    addMessage("bot", "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –∫–∞–º–µ—Ä—ã/–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: "+err.message);
  }
}

input.addEventListener("keydown", e=>{ if(e.key==="Enter") sendMessage(false); });

// –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
addMessage("bot", "–ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏ üìπ —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ –∏ –≥–æ–ª–æ—Å, –∏ –≥–æ–≤–æ—Ä–∏ —Å –ò–ò –æ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–µ–º. üéô –∫–Ω–æ–ø–∫–∞ ‚Äî –æ–∑–≤—É—á–∫–∞ –ò–ò.");
</script>
</body>
</html>
