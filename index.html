<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Pingvi - –ò–ò-—á–∞—Ç</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f9; }
  h2 { display:flex; align-items:center; }
  #chat { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; background: white; }
  .msg { margin: 5px 0; white-space: pre-wrap; display:flex; align-items:center; }
  .user { color: blue; justify-content: flex-start; }
  .bot { color: green; justify-content: flex-start; }
  .penguin { font-size: 50px; margin-right:10px; display:inline-block; }
  @keyframes wave { 0% {transform: rotate(0deg);} 25% {transform: rotate(15deg);} 50% {transform: rotate(0deg);} 75% {transform: rotate(-15deg);} 100% {transform: rotate(0deg);} }
  .wave { animation: wave 0.5s ease-in-out infinite; transform-origin: bottom center; display:inline-block; }
  #controls { margin-top: 10px; }
</style>
</head>
<body>
<h2>Pingvi üêß</h2>
<div id="chat"></div>

<div id="controls">
  <input id="input" type="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="width:50%">
  <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  <button onclick="startListening()">üé§ –ì–æ–ª–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
  <button onclick="resetChat()">–°–±—Ä–æ—Å–∏—Ç—å</button>
  <button onclick="saveChat()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <br><br>
  <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å –≥–æ–ª–æ—Å–∞ –ò–ò: <span id="volLabel">50</span>%</label>
  <input type="range" id="volumeSlider" min="0" max="100" value="50">
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const volumeSlider = document.getElementById('volumeSlider');
const volLabel = document.getElementById('volLabel');
const API_KEY = "AIzaSyCPJwayDaH4Lrb0fw8MypQYHP3xdr2KA9I";
const MODEL = "gemini-2.5-flash";
let history = [];
let recognition = null;
let volume = 0.5;

volumeSlider.addEventListener('input', () => {
  volume = volumeSlider.value / 100;
  volLabel.textContent = volumeSlider.value;
});

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
function addMessage(sender, text) {
  const div = document.createElement('div');
  div.className = 'msg ' + sender;
  
  if(sender === 'bot') {
    // –ü–∏–Ω–≥–≤–∏–Ω
    const penguin = document.createElement('span');
    penguin.className = 'penguin';
    penguin.textContent = 'üêß';
    div.appendChild(penguin);
  }
  
  const span = document.createElement('span');
  span.textContent = text;
  div.appendChild(span);
  
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  
  return div;
}

// –°–±—Ä–æ—Å —á–∞—Ç–∞
function resetChat() {
  history = [];
  chat.innerHTML = "";
  addMessage("bot", "–ü—Ä–∏–≤–µ—Ç! –Ø Pingvi üêß. –î–∞–≤–∞–π –ø–æ–≥–æ–≤–æ—Ä–∏–º!");
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
function saveChat() {
  let text = "";
  history.forEach(m => {
    const role = m.role === "user" ? "–¢—ã" : "Pingvi";
    text += `${role}: ${m.parts[0].text}\n`;
  });
  const blob = new Blob([text], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "chat_history.txt";
  a.click();
  URL.revokeObjectURL(url);
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage() {
  const text = input.value.trim();
  if(!text) return;

  addMessage('user', text);
  history.push({ role:"user", parts:[{text}] });
  input.value='';

  const botDiv = addMessage('bot', "Pingvi –¥—É–º–∞–µ—Ç...");
  const penguin = botDiv.querySelector('.penguin');
  if(penguin) penguin.classList.add('wave'); // –Ω–∞—á–∏–Ω–∞–µ–º –º–∞—Ö–∞—Ç—å –∫—Ä—ã–ª–æ–º

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: history })
      }
    );

    const data = await response.json();
    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "–ù–µ –ø–æ–Ω—è–ª ü§î";

    botDiv.textContent = "";
    addMessage("bot", reply);
    history.push({ role:"model", parts:[{text:reply}] });

    // –ì–æ–ª–æ—Å –ò–ò
    const utterance = new SpeechSynthesisUtterance(reply);
    utterance.lang="ru-RU";
    utterance.volume = volume;

    // –í–æ –≤—Ä–µ–º—è —Ä–µ—á–∏ –ø–∏–Ω–≥–≤–∏–Ω –º–∞—à–µ—Ç
    utterance.onstart = () => {
      const lastBot = chat.lastChild.querySelector('.penguin');
      if(lastBot) lastBot.classList.add('wave');
    };
    utterance.onend = () => {
      const lastBot = chat.lastChild.querySelector('.penguin');
      if(lastBot) lastBot.classList.remove('wave');
    };

    speechSynthesis.speak(utterance);

  } catch(err) {
    botDiv.textContent = "Pingvi: –û—à–∏–±–∫–∞ ("+err.message+")";
  }
}

// –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function startListening() {
  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang='ru-RU';
  recognition.interimResults=false;
  recognition.maxAlternatives=1;

  recognition.start();
  recognition.onresult = (event) => {
    const speech = event.results[0][0].transcript;
    input.value = speech;
    sendMessage(); // –≥–æ–ª–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –±–æ—Ç + –æ–∑–≤—É—á–∫–∞ Pingvi
    recognition.start(); // –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–ª—É—à–∞—Ç—å
  };

  recognition.onerror = (event) => {
    console.error("Speech recognition error", event);
    recognition.stop();
  };
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
input.addEventListener("keydown", e=>{ if(e.key==="Enter") sendMessage(); });

// –°—Ç–∞—Ä—Ç–æ–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
resetChat();
</script>
</body>
</html>
