<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Pingvi v3 üêß</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f9; }
  h2 { display:flex; align-items:center; }
  #chat { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; background: white; }
  .msg { margin: 10px 0; display:flex; align-items:flex-start; }
  .user { color: blue; }
  .bot { color: green; }
  .penguin { font-size: 50px; margin-right:10px; }
  .text { max-width: 80%; }
  #controls { margin-top: 10px; }
  .markdown p { margin: 5px 0; }
  .markdown code { background:#eee; padding:2px 4px; border-radius:4px; }
  .markdown pre { background:#eee; padding:8px; border-radius:8px; overflow-x:auto; }
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<h2>Pingvi v3 üêß</h2>
<div id="chat"></div>

<div id="controls">
  <input id="input" type="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="width:50%">
  <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  <button onclick="startListening()">üé§ –ì–æ–ª–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
  <button onclick="resetChat()">–°–±—Ä–æ—Å–∏—Ç—å</button>
  <button onclick="saveChat()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button onclick="toggleJokeMode()">üé≤ –†–µ–∂–∏–º —à—É—Ç–æ–∫: <span id="jokeStatus">–í—ã–∫–ª</span></button>
  <br><br>
  <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å: <span id="volLabel">50</span>%</label>
  <input type="range" id="volumeSlider" min="0" max="100" value="50">
  <br><br>
  <label>–ì–æ–ª–æ—Å Pingvi:</label>
  <select id="voiceSelect"></select>
  <br><br>
  <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É:</label>
  <input type="file" id="imageUpload" accept="image/*">
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const volumeSlider = document.getElementById('volumeSlider');
const volLabel = document.getElementById('volLabel');
const voiceSelect = document.getElementById('voiceSelect');
const imageUpload = document.getElementById('imageUpload');
const jokeStatus = document.getElementById('jokeStatus');

const API_KEY = "AIzaSyCPJwayDaH4Lrb0fw8MypQYHP3xdr2KA9I"; 
const MODEL = "gemini-2.5-flash";
let history = [];
let recognition = null;
let volume = 0.5;
let voices = [];
let jokeMode = false;

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
volumeSlider.addEventListener('input', () => {
  volume = volumeSlider.value / 100;
  volLabel.textContent = volumeSlider.value;
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤
function loadVoices() {
  voices = speechSynthesis.getVoices();
  voiceSelect.innerHTML = "";
  voices.forEach((v, i) => {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = `${v.name} (${v.lang})`;
    voiceSelect.appendChild(option);
  });
}
speechSynthesis.onvoiceschanged = loadVoices;

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
function addMessage(sender, text, markdown=false) {
  const div = document.createElement('div');
  div.className = 'msg ' + sender;

  if(sender === 'bot') {
    const penguin = document.createElement('span');
    penguin.className = 'penguin';
    penguin.textContent = 'üêß';
    div.appendChild(penguin);
  }

  const span = document.createElement('div');
  span.className = 'text markdown';
  span.innerHTML = markdown ? marked.parse(text) : text;
  div.appendChild(span);

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

// –°–±—Ä–æ—Å
function resetChat() {
  history = [];
  chat.innerHTML = "";
  addMessage("bot", "–ü—Ä–∏–≤–µ—Ç! –Ø Pingvi üêß. –î–∞–≤–∞–π –ø–æ–≥–æ–≤–æ—Ä–∏–º!", true);
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
function saveChat() {
  let text = "";
  history.forEach(m => {
    const role = m.role === "user" ? "–¢—ã" : "Pingvi";
    text += `${role}: ${m.parts[0].text}\n`;
  });
  const blob = new Blob([text], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "chat_history.txt";
  a.click();
  URL.revokeObjectURL(url);
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —à—É—Ç–æ–∫
function toggleJokeMode() {
  jokeMode = !jokeMode;
  jokeStatus.textContent = jokeMode ? "–í–∫–ª" : "–í—ã–∫–ª";
  if(jokeMode) {
    addMessage("bot", "üéâ –•–æ-—Ö–æ! Pingvi —Ç–µ–ø–µ—Ä—å –≤ —Ä–µ–∂–∏–º–µ —à—É—Ç–æ–∫! –ì–æ—Ç–æ–≤—å—Å—è –∫ –≤–µ—Å–µ–ª—å—é!", true);
  } else {
    addMessage("bot", "üòå Pingvi —Å–Ω–æ–≤–∞ —Å–µ—Ä—å—ë–∑–µ–Ω. –ú–æ–∂–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç—å –ø–æ –¥–µ–ª—É.", true);
  }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage(imageData=null) {
  const text = input.value.trim();
  if(!text && !imageData) return;

  if(text) {
    addMessage('user', text);
    history.push({ role:"user", parts:[{text}] });
  }
  input.value='';

  const botDiv = addMessage('bot', "Pingvi –¥—É–º–∞–µ—Ç...");
  
  try {
    let body = { contents: history };

    if(imageData) {
      history.push({ role:"user", parts:[{ text: "–ß—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ?" }, { inlineData: { mimeType: "image/png", data: imageData } }] });
      body = { contents: history };
    }

    // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —à—É—Ç–æ–∫ –≤–∫–ª—é—á—ë–Ω ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è –ò–ò
    if(jokeMode) {
      body.systemInstruction = { parts: [{ text: "–û—Ç–≤–µ—á–∞–π —Å —é–º–æ—Ä–æ–º, —à—É—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª—ã, –±—É–¥—å –≤–µ—Å—ë–ª—ã–º –ø–∏–Ω–≥–≤–∏–Ω–æ–º." }] };
    }

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      }
    );

    const data = await response.json();
    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "–ù–µ –ø–æ–Ω—è–ª ü§î";

    botDiv.remove();
    addMessage("bot", reply, true);
    history.push({ role:"model", parts:[{text:reply}] });

    // –û–∑–≤—É—á–∫–∞
    const utterance = new SpeechSynthesisUtterance(reply);
    utterance.lang="ru-RU";
    utterance.volume = volume;

    if(voices.length > 0) {
      utterance.voice = voices[voiceSelect.value] || voices[0];
    }

    speechSynthesis.speak(utterance);

  } catch(err) {
    botDiv.textContent = "Pingvi: –û—à–∏–±–∫–∞ ("+err.message+")";
  }
}

// –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
function startListening() {
  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang='ru-RU';
  recognition.interimResults=false;
  recognition.maxAlternatives=1;

  recognition.start();
  recognition.onresult = (event) => {
    const speech = event.results[0][0].transcript;
    input.value = speech;
    sendMessage();
    recognition.start();
  };

  recognition.onerror = (event) => {
    console.error("Speech recognition error", event);
    recognition.stop();
  };
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏
imageUpload.addEventListener("change", () => {
  const file = imageUpload.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const base64 = reader.result.split(",")[1];
    sendMessage(base64);
  };
  reader.readAsDataURL(file);
});

// Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
input.addEventListener("keydown", e=>{ if(e.key==="Enter") sendMessage(); });

// –°—Ç–∞—Ä—Ç–æ–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
resetChat();
loadVoices();
</script>
</body>
</html>
