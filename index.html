<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Pingvi v7 🐧 Певец</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f9; }
  h2 { display:flex; align-items:center; }
  #chat { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; background: white; }
  .msg { margin: 10px 0; display:flex; align-items:flex-start; }
  .user { color: blue; }
  .bot { color: green; }
  .penguin { font-size: 50px; margin-right:10px; transition: transform 0.3s; }
  .wave { transform: rotate(20deg); }
  .text { max-width: 80%; }
  #controls { margin-top: 10px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<h2>Pingvi v7 🐧 Певец</h2>
<div id="chat"></div>

<div id="controls">
  <input id="input" type="text" placeholder="Напиши сообщение..." style="width:50%">
  <button onclick="sendMessage()">Отправить</button>
  <button onclick="resetChat()">Сбросить</button>
  <br><br>
  <label>Режим Pingvi:</label>
  <select id="modeSelect">
    <option value="normal">Обычный</option>
    <option value="joke">Шутливый 🎲</option>
    <option value="teacher">Учитель 👨‍🏫</option>
    <option value="philosopher">Философ 🤔</option>
    <option value="motivator">Мотиватор 💪</option>
    <option value="historian">Историк 📜</option>
    <option value="poet">Поэт ✒️</option>
    <option value="gamer">Геймер 🎮</option>
    <option value="scientist">Учёный 🔬</option>
    <option value="chef">Шеф-повар 👨‍🍳</option>
    <option value="singer">Певец 🎤</option>
  </select>
  <br><br>
  <label>Громкость голоса: <span id="volLabel">50</span>%</label>
  <input type="range" id="volumeSlider" min="0" max="100" value="50">
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const volumeSlider = document.getElementById('volumeSlider');
const volLabel = document.getElementById('volLabel');
const modeSelect = document.getElementById('modeSelect');

const API_KEY = "AIzaSyCPJwayDaH4Lrb0fw8MypQYHP3xdr2KA9I";
const MODEL = "gemini-2.5-flash";
let history = [];
let volume = 0.5;

// Настройка громкости
volumeSlider.addEventListener('input', () => {
  volume = volumeSlider.value / 100;
  volLabel.textContent = volumeSlider.value;
});

// Добавление сообщения
function addMessage(sender, text, markdown=false) {
  const div = document.createElement('div');
  div.className = 'msg ' + sender;

  if(sender === 'bot') {
    const penguin = document.createElement('span');
    penguin.className = 'penguin';
    penguin.textContent = '🐧';
    div.appendChild(penguin);
    penguin.classList.add('wave');
    setTimeout(()=>penguin.classList.remove('wave'),500);
  }

  const span = document.createElement('div');
  span.className = 'text markdown';
  span.innerHTML = markdown ? marked.parse(text) : text;
  div.appendChild(span);

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

// Сброс
function resetChat() {
  history = [];
  chat.innerHTML = "";
  addMessage("bot", "Привет! Я Pingvi 🐧. Давай поговорим!", true);
}

// Получаем инструкцию по режиму
function getSystemInstruction() {
  switch(modeSelect.value) {
    case "joke": return "Отвечай весело, шути, используй смайлы.";
    case "teacher": return "Объясняй понятно и пошагово, задавай вопросы.";
    case "philosopher": return "Отвечай глубоко и мудро.";
    case "motivator": return "Будь мотиватором: вдохновляй и поддерживай.";
    case "historian": return "Рассказывай как историк с фактами и датами.";
    case "poet": return "Отвечай красиво, стихами или поэтично.";
    case "gamer": return "Говори как геймер, используй игровой сленг.";
    case "scientist": return "Отвечай как учёный, точно и с терминами.";
    case "chef": return "Давай советы и рецепты как шеф-повар.";
    case "singer": return "Отвечай как певец, создавай текст песен и мелодичные строки.";
    default: return "Отвечай спокойно и полезно.";
  }
}

// Функция «пение» текста
function singText(text) {
  const lines = text.split("\n");
  lines.forEach((line, index) => {
    const utterance = new SpeechSynthesisUtterance(line);
    utterance.lang = "ru-RU";
    utterance.volume = volume;
    utterance.rate = 1 + Math.random()*0.2;
    utterance.pitch = 1 + Math.random()*0.5;
    setTimeout(() => speechSynthesis.speak(utterance), index * 1200);
  });
}

// Отправка сообщения
async function sendMessage() {
  const text = input.value.trim();
  if(!text) return;

  addMessage('user', text);
  history.push({ role:"user", parts:[{text}] });
  input.value='';

  const botDiv = addMessage('bot', "Pingvi думает...");

  try {
    const body = {
      contents: history,
      systemInstruction: { parts:[{text:getSystemInstruction()}] }
    };

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
      { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body) }
    );

    const data = await response.json();
    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Не понял 🤔";

    botDiv.remove();
    addMessage("bot", reply, true);
    history.push({ role:"model", parts:[{text:reply}] });

    // Если режим «Певец», используем singText
    if(modeSelect.value==="singer") {
      singText(reply);
    } else {
      const utterance = new SpeechSynthesisUtterance(reply);
      utterance.lang="ru-RU";
      utterance.volume = volume;
      speechSynthesis.speak(utterance);
    }

  } catch(err) {
    botDiv.textContent = "Pingvi: Ошибка ("+err.message+")";
  }
}

// Enter для отправки
input.addEventListener("keydown", e=>{ if(e.key==="Enter") sendMessage(); });

// Стартовое приветствие
resetChat();
</script>
</body>
</html>
