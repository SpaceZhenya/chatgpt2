<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ò–ò-—á–∞—Ç —Å –º—É–ª—å—Ç–∏–º–µ–¥–∏–∞</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f9; }
    #chat { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; background: white; }
    .msg { margin: 5px 0; white-space: pre-wrap; }
    .user { color: blue; }
    .bot { color: green; }
    img, video { max-width: 80%; display: block; margin: 5px 0; border-radius: 10px; }
    #controls { margin-top: 10px; }
  </style>
</head>
<body>
  <h2>–ò–ò-—á–∞—Ç (Gemini 2.5 Flash + —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ)</h2>
  <div id="chat"></div>

  <div id="controls">
    <input id="input" type="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="width:60%">
    <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button onclick="resetChat()">–°–±—Ä–æ—Å–∏—Ç—å</button>
    <button onclick="saveChat()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <input type="file" id="fileInput" accept="image/*,video/*">
    <button onclick="sendFile()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª</button>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const fileInput = document.getElementById('fileInput');
    const API_KEY = "AIzaSyCPJwayDaH4Lrb0fw8MypQYHP3xdr2KA9I"; // –≤—Å—Ç–∞–≤—å —Å–≤–æ–π –∫–ª—é—á Gemini
    const MODEL = "gemini-2.5-flash";

    let history = [];

    function addMessage(sender, content, type="text") {
      const div = document.createElement('div');
      div.className = 'msg ' + sender;

      if(type === "text") div.textContent = sender.toUpperCase() + ': ' + content;
      else if(type === "image") {
        div.textContent = sender.toUpperCase() + ':';
        const img = document.createElement('img');
        img.src = content;
        div.appendChild(img);
      } else if(type === "video") {
        div.textContent = sender.toUpperCase() + ':';
        const video = document.createElement('video');
        video.src = content;
        video.controls = true;
        div.appendChild(video);
      }

      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    function resetChat() {
      history = [];
      chat.innerHTML = "";
      addMessage("bot", "–ß–∞—Ç –æ—á–∏—â–µ–Ω. –ù–∞—á–Ω—ë–º –∑–∞–Ω–æ–≤–æ!");
    }

    function saveChat() {
      let text = "";
      history.forEach(m => {
        const role = m.role === "user" ? "–¢—ã" : "–ë–æ—Ç";
        if(m.type === "text") text += `${role}: ${m.parts[0].text}\n`;
        else text += `${role}: [${m.type}]\n`;
      });

      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "chat_history.txt";
      a.click();
      URL.revokeObjectURL(url);
    }

    async function sendMessage() {
      const text = input.value.trim();
      if(!text) return;
      addMessage('user', text);
      history.push({ role: "user", parts: [{ text }], type:"text" });
      input.value = '';

      const botDiv = addMessage('bot', "–î—É–º–∞—é...");

      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: history })
          }
        );

        const data = await response.json();
        console.log(data);

        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "–ù–µ –ø–æ–Ω—è–ª ü§î";
        botDiv.textContent = "BOT: " + reply;
        history.push({ role: "model", parts: [{ text: reply }], type:"text" });

      } catch(err) {
        botDiv.textContent = "BOT: –û—à–∏–±–∫–∞ (" + err.message + ")";
      }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤
    function sendFile() {
      const file = fileInput.files[0];
      if(!file) return;

      const url = URL.createObjectURL(file);
      const type = file.type.startsWith("image") ? "image" : "video";

      addMessage("user", file.name, type);
      history.push({ role:"user", parts:[{text: file.name}], type });

      fileInput.value = "";
    }

    // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    input.addEventListener("keydown", e => {
      if(e.key === "Enter") sendMessage();
    });

    // –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    addMessage("bot", "–ü—Ä–∏–≤–µ—Ç! –¢–µ–ø–µ—Ä—å —è –º–æ–≥—É –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ –∏ –≤–∏–¥–µ–æ!");
  </script>
</body>
</html>
