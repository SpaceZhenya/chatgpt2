<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Pingvi v5 🐧</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f9; }
  h2 { display:flex; align-items:center; }
  #chat { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; background: white; }
  .msg { margin: 10px 0; display:flex; align-items:flex-start; }
  .user { color: blue; }
  .bot { color: green; }
  .penguin { font-size: 50px; margin-right:10px; }
  .text { max-width: 80%; }
  #controls { margin-top: 10px; }
  .markdown p { margin: 5px 0; }
  .markdown code { background:#eee; padding:2px 4px; border-radius:4px; }
  .markdown pre { background:#eee; padding:8px; border-radius:8px; overflow-x:auto; }
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<h2>Pingvi v5 🐧</h2>
<div id="chat"></div>

<div id="controls">
  <input id="input" type="text" placeholder="Напиши сообщение..." style="width:50%">
  <button onclick="sendMessage()">Отправить</button>
  <button onclick="startListening()">🎤 Голос пользователя</button>
  <button onclick="resetChat()">Сбросить</button>
  <button onclick="saveChat()">💾 Сохранить</button>
  <br><br>
  <label>Режим Pingvi:</label>
  <select id="modeSelect">
    <option value="normal">Обычный</option>
    <option value="joke">Шутливый 🎲</option>
    <option value="teacher">Учитель 👨‍🏫</option>
    <option value="philosopher">Философ 🤔</option>
    <option value="motivator">Мотиватор 💪</option>
    <option value="historian">Историк 📜</option>
    <option value="poet">Поэт ✒️</option>
    <option value="gamer">Геймер 🎮</option>
    <option value="scientist">Учёный 🔬</option>
    <option value="chef">Шеф-повар 👨‍🍳</option>
  </select>
  <br><br>
  <label>Громкость: <span id="volLabel">50</span>%</label>
  <input type="range" id="volumeSlider" min="0" max="100" value="50">
  <br><br>
  <label>Голос Pingvi:</label>
  <select id="voiceSelect"></select>
  <br><br>
  <label>Загрузить картинку:</label>
  <input type="file" id="imageUpload" accept="image/*">
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const volumeSlider = document.getElementById('volumeSlider');
const volLabel = document.getElementById('volLabel');
const voiceSelect = document.getElementById('voiceSelect');
const imageUpload = document.getElementById('imageUpload');
const modeSelect = document.getElementById('modeSelect');

const API_KEY = "AIzaSyCPJwayDaH4Lrb0fw8MypQYHP3xdr2KA9I";
const MODEL = "gemini-2.5-flash";
let history = [];
let recognition = null;
let volume = 0.5;
let voices = [];

// Настройка громкости
volumeSlider.addEventListener('input', () => {
  volume = volumeSlider.value / 100;
  volLabel.textContent = volumeSlider.value;
});

// Загрузка голосов
function loadVoices() {
  voices = speechSynthesis.getVoices();
  voiceSelect.innerHTML = "";
  voices.forEach((v, i) => {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = `${v.name} (${v.lang})`;
    voiceSelect.appendChild(option);
  });
}
speechSynthesis.onvoiceschanged = loadVoices;

// Добавление сообщения
function addMessage(sender, text, markdown=false) {
  const div = document.createElement('div');
  div.className = 'msg ' + sender;

  if(sender === 'bot') {
    const penguin = document.createElement('span');
    penguin.className = 'penguin';
    penguin.textContent = '🐧';
    div.appendChild(penguin);
  }

  const span = document.createElement('div');
  span.className = 'text markdown';
  span.innerHTML = markdown ? marked.parse(text) : text;
  div.appendChild(span);

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

// Сброс
function resetChat() {
  history = [];
  chat.innerHTML = "";
  addMessage("bot", "Привет! Я Pingvi 🐧. Давай поговорим!", true);
}

// Сохранение истории
function saveChat() {
  let text = "";
  history.forEach(m => {
    const role = m.role === "user" ? "Ты" : "Pingvi";
    text += `${role}: ${m.parts[0].text}\n`;
  });
  const blob = new Blob([text], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "chat_history.txt";
  a.click();
  URL.revokeObjectURL(url);
}

// Получаем инструкцию по режиму
function getSystemInstruction() {
  switch(modeSelect.value) {
    case "joke": return "Отвечай весело, шути, используй смайлы, будь забавным пингвином.";
    case "teacher": return "Объясняй как учитель: понятно, пошагово, задавай вопросы ученику.";
    case "philosopher": return "Отвечай мудро, глубоко, используй философские рассуждения.";
    case "motivator": return "Будь мотиватором: вдохновляй, поддерживай, говори с энергией.";
    case "historian": return "Отвечай как историк: подробно, с фактами и датами, описывай события точно.";
    case "poet": return "Отвечай стихами или красиво оформленными фразами, как поэт.";
    case "gamer": return "Отвечай как геймер: используй сленг и игровые термины.";
    case "scientist": return "Отвечай как учёный: точно, с терминами и фактами, как исследователь.";
    case "chef": return "Отвечай как шеф-повар: давай советы и рецепты, объясняй процесс готовки.";
    default: return "Отвечай спокойно и полезно, как обычный помощник.";
  }
}

// Отправка сообщения
async function sendMessage(imageData=null) {
  const text = input.value.trim();
  if(!text && !imageData) return;

  if(text) {
    addMessage('user', text);
    history.push({ role:"user", parts:[{text}] });
  }
  input.value='';

  const botDiv = addMessage('bot', "Pingvi думает...");

  try {
    let body = { contents: history };
    if(imageData) {
      history.push({ role:"user", parts:[{ text: "Что изображено на картинке?" }, { inlineData: { mimeType: "image/png", data: imageData } }] });
      body = { contents: history };
    }

    body.systemInstruction = { parts: [{ text: getSystemInstruction() }] };

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      }
    );

    const data = await response.json();
    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Не понял 🤔";

    botDiv.remove();
    addMessage("bot", reply, true);
    history.push({ role:"model", parts:[{text:reply}] });

    // Озвучка
    const utterance = new SpeechSynthesisUtterance(reply);
    utterance.lang="ru-RU";
    utterance.volume = volume;
    if(voices.length > 0) {
      utterance.voice = voices[voiceSelect.value] || voices[0];
    }
    speechSynthesis.speak(utterance);

  } catch(err) {
    botDiv.textContent = "Pingvi: Ошибка ("+err.message+")";
  }
}

// Голосовой ввод
function startListening() {
  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang='ru-RU';
  recognition.interimResults=false;
  recognition.maxAlternatives=1;

  recognition.start();
  recognition.onresult = (event) => {
    const speech = event.results[0][0].transcript;
    input.value = speech;
    sendMessage();
    recognition.start();
  };

  recognition.onerror = (event) => {
    console.error("Speech recognition error", event);
    recognition.stop();
  };
}

// Загрузка картинки
imageUpload.addEventListener("change", () => {
  const file = imageUpload.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const base64 = reader.result.split(",")[1];
    sendMessage(base64);
  };
  reader.readAsDataURL(file);
});

// Enter для отправки
input.addEventListener("keydown", e=>{ if(e.key==="Enter") sendMessage(); });

// Стартовое приветствие
resetChat();
loadVoices();
</script>
</body>
</html>
