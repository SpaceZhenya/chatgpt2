<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ò–ò-—á–∞—Ç —Å –≤–∏–¥–µ–æ</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f9; }
  #chat { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; background: white; }
  .msg { margin: 5px 0; white-space: pre-wrap; }
  .user { color: blue; }
  .bot { color: green; }
  #videoContainer { margin-top: 10px; }
</style>
</head>
<body>
<h2>–ò–ò-—á–∞—Ç —Å –≤–∏–¥–µ–æ</h2>
<div id="chat"></div>

<div id="controls">
  <input id="input" type="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="width:50%">
  <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  <button onclick="startCamera()">üìπ –í–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ</button>
  <button onclick="resetChat()">–°–±—Ä–æ—Å–∏—Ç—å</button>
  <button onclick="saveChat()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<div id="videoContainer">
  <video id="video" width="320" height="240" autoplay muted></video>
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const video = document.getElementById('video');
const API_KEY = "AIzaSyCPJwayDaH4Lrb0fw8MypQYHP3xdr2KA9I";
const MODEL = "gemini-2.5-flash";
let history = [];

// –ß–∞—Ç
function addMessage(sender, text) {
  const div = document.createElement('div');
  div.className = 'msg ' + sender;
  div.textContent = sender.toUpperCase() + ': ' + text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

function resetChat() {
  history = [];
  chat.innerHTML = "";
  addMessage("bot", "–ß–∞—Ç –æ—á–∏—â–µ–Ω. –ù–∞—á–Ω—ë–º –∑–∞–Ω–æ–≤–æ!");
}

function saveChat() {
  let text = "";
  history.forEach(m => {
    const role = m.role === "user" ? "–¢—ã" : "–ë–æ—Ç";
    text += `${role}: ${m.parts[0].text}\n`;
  });
  const blob = new Blob([text], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "chat_history.txt";
  a.click();
  URL.revokeObjectURL(url);
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage() {
  const text = input.value.trim();
  if(!text) return;
  addMessage('user', text);
  history.push({ role:"user", parts:[{text}] });
  input.value='';

  const botDiv = addMessage('bot', "–î—É–º–∞—é...");

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: history })
      }
    );

    const data = await response.json();
    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "–ù–µ –ø–æ–Ω—è–ª ü§î";
    botDiv.textContent = "";
    addMessage("bot", reply);
    history.push({ role:"model", parts:[{text: reply}] });

  } catch(err) {
    botDiv.textContent = "BOT: –û—à–∏–±–∫–∞ (" + err.message + ")";
  }
}

// –í–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    video.srcObject = stream;
    addMessage("bot", "–í–∏–¥–µ–æ –≤–∫–ª—é—á–µ–Ω–æ. –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –≥–æ–≤–æ—Ä–∏—Ç—å –æ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–µ–º.");
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –∫–∞–¥—Ä–æ–≤ –Ω–∞ API –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
  } catch(err) {
    addMessage("bot", "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –∫–∞–º–µ—Ä—ã: " + err.message);
  }
}

input.addEventListener("keydown", e => { if(e.key==="Enter") sendMessage(); });

// –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
addMessage("bot", "–ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏ üìπ —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ –∏ –≥–æ–≤–æ—Ä–∏ —Å –ò–ò –æ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–µ–º.");
</script>
</body>
</html>
